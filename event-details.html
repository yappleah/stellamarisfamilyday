<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      .toast-blur-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 9998;
        background: rgba(0, 0, 0, 0.18);
        backdrop-filter: blur(6px);
      }
    </style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Event Donations</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      #loadingScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.3); /* lighter background */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(4px); /* optional blur */
      }

      #ordersContainer .table-responsive {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        max-height: 70vh;
        overflow-x: auto;
        overflow-y: auto;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }

      #ordersContainer .table {
        margin-bottom: 0;
        width: 100%;
        table-layout: auto;
      }

      #ordersContainer .table th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 10;
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
      }

      #ordersContainer .table td {
        padding: 0.5rem;
        font-size: 0.875rem;
        vertical-align: middle;
        word-wrap: none;
      }

      #ordersContainer .table .btn-sm {
        padding: 0.15rem 0.3rem;
        font-size: 0.7rem;
        line-height: 1.2;
        min-width: 24px;
        height: 24px;
      }

      #ordersContainer .table .btn-sm i {
        font-size: 0.65rem;
      }

      /* Scrollbar styling */
      .table-responsive::-webkit-scrollbar {
        height: 8px;
        width: 8px;
      }

      .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body style="background-color: #d0f0ff">
    <div class="container bg-white min-vh-100">
      <!-- NAVBAR -->
      <nav
        class="navbar navbar-expand-lg navbar-dark"
        style="background-color: #2f4f4f"
      >
        <div class="container">
          <a class="navbar-brand" href="index.html"
            >üéÑ Stella Maris Lights of Hope</a
          >
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div
            class="collapse navbar-collapse justify-content-end"
            id="navbarNav"
          >
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="index.html#about">About Us</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="index.html#expect">What to Expect</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="donation-form.html"
                  >Donation Pledge Form</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="admin-portal-9831.html"
                  >Admin Dashboard</a
                >
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <header class="bg-light text-center py-2 mb-4">
        <div class="container">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Event Donations</h2>
            <div class="text-end mb-3">
              <button
                id="adminSignOut"
                class="btn btn-outline-danger"
                onclick="signOut()"
                style="display: none"
              >
                Sign Out
              </button>
            </div>
          </div>
        </div>
      </header>

      <div class="px-1 pb-5">
        <div class="mb-3">
          <span id="editOutstanding" style="display: none"></span>
          <a href="admin-portal-9831.html" class="btn btn-link text-secondary"
            >Back</a
          >
        </div>
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="mb-0" id="eventTitle">Event Donations</h2>
          <div class="btn-group" role="group">
            <button id="ordersViewBtn" class="btn btn-primary">
              <i class="bi bi-table"></i> Donations
            </button>
            <button id="paymentsViewBtn" class="btn btn-outline-primary">
              <i class="bi bi-credit-card"></i> Payments
            </button>
          </div>
        </div>
        <div id="searchFilters">
          <div class="row mb-3">
            <div class="col-md-4 mb-2">
              <label class="form-label fw-bold">Payment Status</label>
              <select id="filterPaid" class="form-select">
                <option value="">All Payment Status</option>
                <option value="paid">Paid</option>
                <option value="unpaid">Pending</option>
              </select>
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label fw-bold">Payment Method</label>
              <select id="filterPaymentMethod" class="form-select">
                <option value="">All Payment Methods</option>
                <option value="cash">Cash/Cheque</option>
                <option value="bank transfer">Bank Transfer</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <input
              type="text"
              id="orderSearch"
              class="form-control"
              placeholder="Search by name, email, or phone number"
            />
          </div>
        </div>

        <div id="ordersContainer"></div>
        <div id="paymentsContainer" style="display: none"></div>
      </div>
    </div>
    <!-- FOOTER -->
    <footer class="text-center py-4 bg-light mt-5">
      <p class="mb-1">
        <strong>üìç Stella Maris Church Grounds</strong> |
        <span id="dateAndTime"></span>
      </p>
      <p class="mb-1">
        üìû 876-925-9520 | üìß
        <a href="mailto:stellamarisfamilyday@gmail.com"
          >stellamarisfamilyday@gmail.com</a
        >
      </p>
      <small class="text-muted"
        >#StellaMarisLightsOfHope #JamaicaStrong #TogetherForJamaica #HopeForAll
      </small>
      <p>
        &copy; <span id="year"></span> by Stella Maris Catholic Church Jamaica
      </p>
    </footer>

    <!-- Edit Donation Modal -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Donation</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="editDonationId" />

              <div class="mb-3">
                <label for="editName" class="form-label">Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="editName"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editEmail" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="editEmail"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editPhone" class="form-label">Phone</label>
                <input
                  type="tel"
                  class="form-control"
                  id="editPhone"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="editPledgeAmount" class="form-label"
                  >Pledge Amount</label
                >
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  class="form-control"
                  id="editPledgeAmount"
                  required
                />
              </div>

              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Modal -->
    <div
      class="modal fade"
      id="paymentModal"
      tabindex="-1"
      aria-labelledby="paymentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="paymentModalLabel">Record Payment</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="paymentForm">
              <input type="hidden" id="donationId" />

              <div class="mb-3">
                <label class="form-label">Outstanding Balance</label>
                <div class="alert alert-info">
                  <strong id="paymentOutstanding">Loading...</strong>
                </div>
              </div>

              <div class="mb-3">
                <label for="paymentDate" class="form-label">Payment Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="paymentDate"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="paymentAmount" class="form-label"
                  >Payment Amount</label
                >
                <input
                  type="number"
                  step="0.01"
                  min="0"
                  class="form-control"
                  id="paymentAmount"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="paymentMethod" class="form-label"
                  >Payment Method</label
                >
                <select class="form-select" id="paymentMethod" required>
                  <option value="cash">Cash/Cheque</option>
                  <option value="bank transfer">Bank Transfer</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="referenceNumber" class="form-label"
                  >Reference Number (Optional)</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="referenceNumber"
                  placeholder="e.g., Check #, Transaction ID"
                />
              </div>

              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-success">
                  Record Payment
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingScreen">
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="functions.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
      emailjs.init("-RrY_RPQHt4a9S2Mc");
      document.getElementById("dateAndTime").textContent = CONFIG.EVENT.date;
      document.getElementById("year").textContent = new Date().getFullYear();

      let allOrders = [];
      const supabaseClient = supabase.createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_ANON_KEY
      );

      const params = new URLSearchParams(window.location.search);

      async function loadEventDetails(id) {
        const { data: event, error } = await supabaseClient
          .from("events")
          .select("name")
          .eq("id", id)
          .maybeSingle();

        if (event && event.name) {
          document.getElementById("eventTitle").textContent = `${event.name}`;
          loadOrders(id);
        } else {
          document.getElementById("ordersContainer").innerHTML =
            "<p class='text-danger'>No event found for the given ID.</p>";
        }
      }

      let eventId = params.get("eventId");

      if (!eventId) {
        document.getElementById("ordersContainer").innerHTML =
          "<p class='text-danger'>No event specified.</p>";
      } else {
        if (sessionStorage.getItem("adminLoggedIn") !== "true") {
          window.location.href = "admin-portal-9831.html";
        }
        loadEventDetails(eventId);
      }

      async function loadOrders(eventId) {
        showLoadingScreen();

        const { data, error } = await supabaseClient
          .from("donations")
          .select("*");

        hideLoadingScreen();

        if (error || !data || data.length === 0) {
          document.getElementById("ordersContainer").innerHTML =
            "<p class='text-warning'>No donations found for this event.</p>";
          return;
        }
        allOrders = data;
        renderOrders(allOrders);

        // Initialize the view based on saved state
        updateViewDisplay();
      }

      document.getElementById("orderSearch").addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allOrders.filter((donation) => {
          const nameMatch = (donation.name || "")
            .toLowerCase()
            .includes(searchTerm);
          const emailMatch = (donation.email || "")
            .toLowerCase()
            .includes(searchTerm);
          const phoneMatch = (donation.phone_number || "")
            .toLowerCase()
            .includes(searchTerm);

          return nameMatch || emailMatch || phoneMatch;
        });

        renderOrders(filtered);
      });

      function renderOrders(data) {
        // Store filtered orders globally for download
        currentFilteredOrders = data;

        document.getElementById("ordersContainer").innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <small class="text-muted">
          Total donations: <span>${data.length}</span>
        </small>
        <button id="downloadOrdersResults" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-download"></i> Download Donations
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th><strong>Actions</strong></th>
              <th><strong>Name</strong></th>
              <th><strong>Email</strong></th>
              <th><strong>Phone</strong></th>
              <th><strong>Pledge Amount</strong></th>
              <th><strong>Amount Paid</strong></th>
              <th><strong>Payment Method</strong></th>
              <th><strong>Status</strong></th>
            </tr>
          </thead>
          <tbody>
            ${data
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .map(
                (donation) => `
                <tr>
                  <td>
                    ${
                      !donation.paid
                        ? `<button class="btn btn-sm btn-success mb-1" title="Record Payment" onclick="openPaymentModal('${donation.id}', '${donation.payment_method}')"><i class="bi bi-cash-stack"></i></button>`
                        : ``
                    }
                         ${
                           !donation.paid
                             ? `<button class="btn btn-sm btn-primary mb-1" title="Edit Donation" onclick="openEditModal('${donation.id}')">
                      <i class="bi bi-pencil-square"></i>
                    </button>`
                             : ``
                         }
                         ${
                           !donation.paid
                             ? `<button class="btn btn-sm btn-info mb-1" title="Resend Confirmation Email" onclick='resendConfirmationEmail("${donation.id}", ${JSON.stringify(donation.name)}, ${JSON.stringify(donation.email)}, ${donation.pledge_amount}, "${donation.payment_method}")'>
                      <i class="bi bi-envelope"></i>
                    </button>`
                             : ``
                         }
                  </td>
                  <td>${donation.name}</td>
                  <td>${donation.email || "N/A"}</td>
                  <td>${donation.phone_number ? formatPhoneNumber(donation.phone_number) : "N/A"}</td>
                  <td>$${formatCurrency(donation.pledge_amount || 0)}</td>
                  <td>$${formatCurrency(donation.amount_paid || 0)}</td>
                  <td>
                    <span class="badge ${
                      donation.payment_method === "cash" ? "bg-success" : "bg-info"
                    }">
                      ${donation.payment_method === "cash" ? "Cash/Cheque" : "Bank Transfer"}
                    </span>
                  </td>
                  <td>
                    <span class="badge ${
                      donation.paid ? "bg-success" : "bg-warning"
                    }">
                      ${donation.paid ? "Paid" : "Pending"}
                    </span>
                  </td>
                </tr>
              `
              )
              .join("")}
          </tbody>
        </table>
        </div>
      `;

        // Add download functionality for donations
        setTimeout(() => {
          document
            .getElementById("downloadOrdersResults")
            ?.addEventListener("click", downloadOrdersResults);
        }, 0);
      }

      // Store filtered orders globally for download
      let currentFilteredOrders = [];

      // Download function for filtered orders
      function downloadOrdersResults() {
        if (currentFilteredOrders.length === 0) {
          showToastWithBlur(
            "No donations to download. Please adjust your filters.",
            { type: "error", icon: "fas fa-exclamation-triangle" }
          );
          return;
        }

        // Create CSV content with specified columns
        const headers = [
          "Name",
          "Email",
          "Phone",
          "Pledge Amount",
          "Amount Paid",
          "Payment Method",
          "Status",
        ];
        const csvRows = [headers.join(",")];

        currentFilteredOrders.forEach((donation) => {
          // Helper function to escape CSV values
          const escapeCSV = (value) => {
            if (value == null) return "";
            const str = String(value);
            // Remove or replace newlines and carriage returns
            const cleaned = str.replace(/[\r\n]+/g, " ").trim();
            // Escape quotes by doubling them
            const escaped = cleaned.replace(/"/g, '""');
            return escaped;
          };

          const row = [
            `"${escapeCSV(donation.name)}"`,
            `"${escapeCSV(donation.email || "N/A")}"`,
            `"${escapeCSV(donation.phone_number || "N/A")}"`,
            `"${escapeCSV(formatCurrency(donation.pledge_amount || 0))}"`,
            `"${escapeCSV(formatCurrency(donation.amount_paid || 0))}"`,
            `"${escapeCSV(donation.payment_method === "cash" ? "Cash/Cheque" : "Bank Transfer")}"`,
            `"${escapeCSV(donation.paid ? "Paid" : "Pending")}"`,
          ];
          csvRows.push(row.join(","));
        });

        // Create and download CSV file
        const csvContent = csvRows.join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");

        const currentDate = new Date().toISOString().split("T")[0];
        const filename = `donations-${currentDate}.csv`;

        if (link.download !== undefined) {
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", filename);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }

      document
        .getElementById("orderSearch")
        .addEventListener("input", filterAndRender);
      document
        .getElementById("filterPaid")
        .addEventListener("change", filterAndRender);
      document
        .getElementById("filterPaymentMethod")
        .addEventListener("change", filterAndRender);

      function filterAndRender() {
        const searchTerm = document
          .getElementById("orderSearch")
          .value.toLowerCase();
        const paidFilter = document.getElementById("filterPaid").value;
        const paymentMethodFilter = document.getElementById("filterPaymentMethod").value;

        const filtered = allOrders.filter((donation) => {
          const matchesSearch =
            (donation.name || "").toLowerCase().includes(searchTerm) ||
            (donation.email || "").toLowerCase().includes(searchTerm) ||
            (donation.phone_number || "").toLowerCase().includes(searchTerm);

          const matchesPaid =
            paidFilter === "" ||
            (paidFilter === "paid" && donation.paid) ||
            (paidFilter === "unpaid" && !donation.paid);

          const matchesPaymentMethod =
            paymentMethodFilter === "" ||
            donation.payment_method === paymentMethodFilter;

          return matchesSearch && matchesPaid && matchesPaymentMethod;
        });

        renderOrders(filtered);
      }

      // ==================================================
      // DONATION MANAGEMENT FUNCTIONS
      // ==================================================

      async function markAsPaid(donationId) {
        if (!confirm("Mark this donation as paid?")) return;

        const { error } = await supabaseClient
          .from("donations")
          .update({ paid: true })
          .eq("id", donationId);

        if (error) {
          showToastWithBlur("Error updating donation status.", {
            type: "error",
            icon: "fas fa-exclamation-triangle",
          });
          return;
        }

        showToastWithBlur("Donation marked as paid!", {
          type: "success",
          icon: "fas fa-check-circle",
        });
        loadOrders(eventId);
      }

      function openEditModal(donationId) {
        // Convert to number for comparison since IDs from DB are integers
        const numericId = parseInt(donationId);
        const donation = allOrders.find(
          (d) => d.id === numericId || d.id === donationId
        );

        if (!donation) {
          console.error("Donation not found:", donationId);
          console.error(
            "Available IDs:",
            allOrders.map((d) => d.id)
          );
          return;
        }

        document.getElementById("editDonationId").value = donationId;
        document.getElementById("editName").value = donation.name || "";
        document.getElementById("editEmail").value = donation.email || "";
        document.getElementById("editPhone").value =
          donation.phone_number ? formatPhoneNumber(donation.phone_number) : "";
        document.getElementById("editPledgeAmount").value =
          donation.pledge_amount || 0;

        // Try different methods to show the modal
        const modalElement = document.getElementById("editModal");
        if (typeof bootstrap !== "undefined" && bootstrap.Modal) {
          const modal = new bootstrap.Modal(modalElement);
          modal.show();
        } else {
          // Fallback: manually show modal
          modalElement.classList.add("show");
          modalElement.style.display = "block";
          modalElement.setAttribute("aria-modal", "true");
          modalElement.removeAttribute("aria-hidden");
          document.body.classList.add("modal-open");

          // Add backdrop
          const backdrop = document.createElement("div");
          backdrop.className = "modal-backdrop fade show";
          backdrop.id = "editModalBackdrop";
          document.body.appendChild(backdrop);
        }
      }

      function closeEditModal() {
        const modalElement = document.getElementById("editModal");

        if (typeof bootstrap !== "undefined" && bootstrap.Modal) {
          const modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) {
            modal.hide();
          }
        } else {
          // Fallback: manually hide modal
          modalElement.classList.remove("show");
          modalElement.style.display = "none";
          modalElement.setAttribute("aria-hidden", "true");
          modalElement.removeAttribute("aria-modal");
          document.body.classList.remove("modal-open");

          // Remove backdrop
          const backdrop = document.getElementById("editModalBackdrop");
          if (backdrop) {
            backdrop.remove();
          }
        }
      }

      document
        .getElementById("editForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const donationId = document.getElementById("editDonationId").value;
          const newName = document.getElementById("editName").value;
          const newEmail = document.getElementById("editEmail").value;
          const newPhone = document.getElementById("editPhone").value;
          const newAmount = document.getElementById("editPledgeAmount").value;

          const pledgeAmount = parseFloat(newAmount);
          if (isNaN(pledgeAmount) || pledgeAmount < 0) {
            showToastWithBlur("Invalid pledge amount.", {
              type: "error",
              icon: "fas fa-exclamation-triangle",
            });
            return;
          }

          showLoadingScreen();
          
          // Get current donation data to check amount_paid
          const { data: currentDonation, error: fetchError } = await supabaseClient
            .from("donations")
            .select("amount_paid")
            .eq("id", donationId)
            .maybeSingle();

          if (fetchError) {
            showToastWithBlur("Error fetching donation data.", {
              type: "error",
              icon: "fas fa-exclamation-triangle",
            });
            hideLoadingScreen();
            return;
          }

          // Determine if donation should be marked as paid
          const amountPaid = currentDonation?.amount_paid || 0;
          const isPaid = pledgeAmount <= amountPaid;

          const { error } = await supabaseClient
            .from("donations")
            .update({
              name: newName,
              email: newEmail,
              phone_number: newPhone,
              pledge_amount: pledgeAmount,
              paid: isPaid,
            })
            .eq("id", donationId);

          hideLoadingScreen();

          if (error) {
            showToastWithBlur("Error updating donation.", {
              type: "error",
              icon: "fas fa-exclamation-triangle",
            });
            return;
          }

          showToastWithBlur("Donation updated successfully.", {
            type: "success",
            icon: "fas fa-check-circle",
          });

          closeEditModal();
          loadOrders(eventId);
        });

      // ==================================================
      // VIEW MANAGEMENT FUNCTIONALITY
      // ==================================================

      let currentView = localStorage.getItem("eventDetailsView") || "orders";

      // View button event listeners
      document
        .getElementById("ordersViewBtn")
        .addEventListener("click", function () {
          currentView = "orders";
          localStorage.setItem("eventDetailsView", currentView);
          updateViewDisplay();
        });

      document
        .getElementById("paymentsViewBtn")
        .addEventListener("click", function () {
          currentView = "payments";
          localStorage.setItem("eventDetailsView", currentView);
          updateViewDisplay();
        });

      function updateViewDisplay() {
        const ordersContainer = document.getElementById("ordersContainer");
        const paymentsContainer = document.getElementById("paymentsContainer");
        const searchFilters = document.getElementById("searchFilters");
        const ordersBtn = document.getElementById("ordersViewBtn");
        const paymentsBtn = document.getElementById("paymentsViewBtn");

        // Reset all buttons to outline style
        ordersBtn.className = "btn btn-outline-primary";
        paymentsBtn.className = "btn btn-outline-primary";

        // Hide all containers
        ordersContainer.style.display = "none";
        paymentsContainer.style.display = "none";

        if (currentView === "payments") {
          // Show payments view
          paymentsContainer.style.display = "block";
          paymentsBtn.className = "btn btn-primary";
          searchFilters.style.display = "none";
          // Always render payments table, it will handle the empty state
          renderPaymentsTable();
        } else {
          // Show orders view (default)
          ordersContainer.style.display = "block";
          ordersBtn.className = "btn btn-primary";
          searchFilters.style.display = "block";
        }
      }

      // ==================================================
      // PAYMENTS TABLE FUNCTIONALITY
      // ==================================================

      async function renderPaymentsTable() {
        const container = document.getElementById("paymentsContainer");

        // First, get all donations for this event to filter payments
        const { data: eventDonations, error: donationsError } =
          await supabaseClient
            .from("donations")
            .select("id, name, email, phone_number, pledge_amount, amount_paid")
            .eq("event_id", eventId);

        if (donationsError) {
          console.error("Donations load error:", donationsError);
          container.innerHTML =
            "<p class='text-danger'>Error loading donations: " +
            (donationsError.message || "Unknown error") +
            "</p>";
          return;
        }

        if (!eventDonations || eventDonations.length === 0) {
          container.innerHTML =
            "<div class='alert alert-info'><i class='bi bi-info-circle'></i> No donations found for this event.</div>";
          return;
        }

        const donationIds = eventDonations.map((d) => d.id);
        const donationMap = {};
        eventDonations.forEach((d) => {
          donationMap[d.id] = d;
        });

        // Get all payments for these donations
        const { data: payments, error } = await supabaseClient
          .from("payments")
          .select("*")
          .in("donation_id", donationIds)
          .order("payment_date", { ascending: false });

        if (error) {
          console.error("Payment load error:", error);
          container.innerHTML =
            "<p class='text-danger'>Error loading payment history: " +
            (error.message || "Unknown error") +
            "</p>";
          return;
        }

        if (!payments || payments.length === 0) {
          container.innerHTML =
            "<div class='alert alert-info'><i class='bi bi-info-circle'></i> No payments have been recorded for this event yet.</div>";
          return;
        }

        // Attach donation info to each payment
        const paymentsWithDonations = payments.map((payment) => ({
          ...payment,
          donation: donationMap[payment.donation_id] || {},
        }));

        container.innerHTML = `
        <div class="row mb-3">
          <div class="col-md-6 mb-2">
            <label class="form-label fw-bold">Search by Name, Email, or Phone</label>
            <input type="text" id="paymentSearch" class="form-control" placeholder="Search by name, email, or phone number">
          </div>
          <div class="col-md-6 mb-2">
            <label class="form-label fw-bold">Payment Method</label>
            <select id="paymentMethodFilter" class="form-select">
              <option value="">All Payment Methods</option>
              <option value="cash">Cash/Cheque</option>
              <option value="bank transfer">Bank Transfer</option>
            </select>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6 mb-2">
            <label class="form-label fw-bold">Date From</label>
            <input type="date" id="paymentDateFrom" class="form-control" placeholder="From">
          </div>
          <div class="col-md-6 mb-2">
            <label class="form-label fw-bold">Date To</label>
            <input type="date" id="paymentDateTo" class="form-control" placeholder="To">
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">
            <i class="bi bi-arrow-left-right"></i> 
            Scroll horizontally to see all columns ‚Ä¢ Total payments: <span id="paymentCount">${
              paymentsWithDonations.length
            }</span> ‚Ä¢ Total amount: $<span id="paymentTotal">${formatCurrency(
          paymentsWithDonations.reduce((sum, p) => sum + (p.amount || 0), 0)
        )}</span>
          </small>
          <button id="downloadPaymentsResults" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-download"></i> Download Payments
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>Payment Date</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Amount</th>
                <th>Payment Method</th>
                <th>Reference</th>
                <th>Pledge Total</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              ${renderPaymentRows(paymentsWithDonations)}
            </tbody>
          </table>
        </div>
      `;

        // Add filtering functionality for payments
        function filterPayments() {
          const searchTerm = document
            .getElementById("paymentSearch")
            .value.toLowerCase();
          const methodFilter = document.getElementById(
            "paymentMethodFilter"
          ).value;
          const dateFrom = document.getElementById("paymentDateFrom").value;
          const dateTo = document.getElementById("paymentDateTo").value;

          const filteredPayments = paymentsWithDonations.filter((payment) => {
            const matchesSearch =
              !searchTerm ||
              (payment.donation.name || "").toLowerCase().includes(searchTerm) ||
              (payment.donation.email || "").toLowerCase().includes(searchTerm) ||
              (payment.donation.phone_number || "").toLowerCase().includes(searchTerm);

            // Payment method filter
            const matchesMethod =
              !methodFilter || payment.payment_method === methodFilter;

            // Date range filter
            const paymentDate = new Date(payment.payment_date);
            const matchesDateFrom =
              !dateFrom || paymentDate >= new Date(dateFrom);
            const matchesDateTo = !dateTo || paymentDate <= new Date(dateTo);

            return (
              matchesSearch && matchesMethod && matchesDateFrom && matchesDateTo
            );
          });

          currentFilteredPayments = filteredPayments; // Store for download
          document.getElementById("paymentsTableBody").innerHTML =
            renderPaymentRows(filteredPayments);
          document.getElementById("paymentCount").textContent =
            filteredPayments.length;
          document.getElementById("paymentTotal").textContent = formatCurrency(
            filteredPayments.reduce((sum, p) => sum + (p.amount || 0), 0)
          );
        }

        // Store filtered results globally for download
        let currentFilteredPayments = paymentsWithDonations;

        // Download function for filtered payments
        function downloadPaymentsResults() {
          if (currentFilteredPayments.length === 0) {
            showToastWithBlur(
              "No payments to download. Please adjust your filters.",
              { type: "error", icon: "fas fa-exclamation-triangle" }
            );
            return;
          }

          // Create CSV content
          const headers = [
            "Payment Date",
            "Name",
            "Email",
            "Phone",
            "Amount",
            "Payment Method",
            "Reference",
            "Pledge Total",
          ];
          const csvRows = [headers.join(",")];

          currentFilteredPayments.forEach((payment) => {
            // Helper function to escape CSV values
            const escapeCSV = (value) => {
              if (value == null) return "";
              const str = String(value);
              const cleaned = str.replace(/[\r\n]+/g, " ").trim();
              const escaped = cleaned.replace(/"/g, '""');
              return escaped;
            };

            const row = [
              `"${escapeCSV(
                new Date(payment.payment_date).toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                  timeZone: "UTC",
                })
              )}"`,
              `"${escapeCSV(payment.donation.name || "N/A")}"`,
              `"${escapeCSV(payment.donation.email || "N/A")}"`,
              `"${escapeCSV(payment.donation.phone_number || "N/A")}"`,
              `"${escapeCSV(formatCurrency(payment.amount))}"`,
              `"${escapeCSV(
                payment.payment_method === "cash"
                  ? "Cash/Cheque"
                  : "Bank Transfer"
              )}"`,
              `"${escapeCSV(payment.reference_number || "N/A")}"`,
              `"${escapeCSV(
                formatCurrency(payment.donation.pledge_amount || 0)
              )}"`,
            ];
            csvRows.push(row.join(","));
          });

          // Create and download CSV file
          const csvContent = csvRows.join("\n");
          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const link = document.createElement("a");

          const currentDate = new Date().toISOString().split("T")[0];
          const filename = `payment-history-${currentDate}.csv`;

          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        }

        // Add event listeners to all filter controls
        document
          .getElementById("paymentSearch")
          .addEventListener("input", filterPayments);
        document
          .getElementById("paymentMethodFilter")
          .addEventListener("change", filterPayments);
        document
          .getElementById("paymentDateFrom")
          .addEventListener("change", filterPayments);
        document
          .getElementById("paymentDateTo")
          .addEventListener("change", filterPayments);

        // Add download functionality
        document
          .getElementById("downloadPaymentsResults")
          .addEventListener("click", downloadPaymentsResults);
      }

      function renderPaymentRows(payments) {
        if (!payments || payments.length === 0) {
          return `<tr><td colspan="8" class="text-center text-muted py-4">
            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
            <p class="mb-0 mt-2">No payments match your search criteria</p>
          </td></tr>`;
        }

        return payments
          .map((payment) => {
            return `
            <tr>
              <td>${new Date(payment.payment_date).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
                timeZone: "UTC",
              })}</td>
              <td>${payment.donation.name || "N/A"}</td>
              <td>${payment.donation.email || "N/A"}</td>
              <td>${payment.donation.phone_number ? formatPhoneNumber(payment.donation.phone_number) : "N/A"}</td>
              <td><strong>$${formatCurrency(payment.amount)}</strong></td>
              <td>
                <span class="badge ${
                  payment.payment_method === "cash" ? "bg-success" : "bg-info"
                }">
                  ${
                    payment.payment_method === "cash"
                      ? "Cash/Cheque"
                      : "Bank Transfer"
                  }
                </span>
              </td>
              <td>${
                payment.reference_number ||
                '<span class="text-muted">N/A</span>'
              }</td>
              <td>$${formatCurrency(payment.donation.pledge_amount || 0)}</td>
            </tr>
          `;
          })
          .join("");
      }

      async function openPaymentModal(donationId, method) {
        document.getElementById("donationId").value = donationId;
        document.getElementById("paymentMethod").value = method;

        const { data: donation, error } = await supabaseClient
          .from("donations")
          .select("*")
          .eq("id", donationId)
          .maybeSingle();

        if (!donation || error) {
          document.getElementById("paymentOutstanding").textContent =
            "Error loading balance";
          return;
        }

        const outstanding = calculateOutstanding(donation.pledge_amount || 0, [
          { amount: donation.amount_paid || 0 },
        ]);
        document.getElementById(
          "paymentOutstanding"
        ).textContent = `$${formatCurrency(outstanding)}`;

        const modal = new bootstrap.Modal(
          document.getElementById("paymentModal")
        );
        modal.show();
      }

      document
        .getElementById("paymentModal")
        .addEventListener("hidden.bs.modal", () => {
          document.getElementById("paymentForm").reset();
          document.getElementById("paymentOutstanding").textContent =
            "Loading...";
        });

      document
        .getElementById("paymentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const donationId = document.getElementById("donationId").value;
          const paymentDate = document.getElementById("paymentDate").value;
          const paymentAmount = parseFloat(
            document.getElementById("paymentAmount").value
          );
          const paymentMethod = document.getElementById("paymentMethod").value;
          const referenceNumber =
            document.getElementById("referenceNumber").value;

          // Insert new payment transaction
          showLoadingScreen();
          const { error: insertError } = await supabaseClient
            .from("payments")
            .insert({
              donation_id: donationId,
              payment_date: paymentDate,
              amount: paymentAmount,
              payment_method: paymentMethod,
              reference_number: referenceNumber || null,
            });

          if (insertError) {
            showToastWithBlur("Failed to record payment.", {
              type: "error",
              icon: "fas fa-exclamation-triangle",
            });
            console.error(insertError);
            hideLoadingScreen();
            return;
          }

          // Get donation details for email
          const { data: donationData, error: donationFetchError } =
            await supabaseClient
              .from("donations")
              .select("name, email, amount_paid, pledge_amount")
              .eq("id", donationId)
              .maybeSingle();

          if (!donationFetchError && donationData && donationData.email) {
            emailjs
              .send("service_awer6bj", "template_dc04abk", {
                name: donationData.name || "",
                email: donationData.email,
                payment_method:
                  paymentMethod === "cash" ? "Cash/Cheque" : "Bank Transfer",
                payment_date: paymentDate,
                amount_paid: formatCurrency(paymentAmount),
                reference_number: referenceNumber || "",
              })
              .then(() => {
                // Show a centered success modal with a check icon (auto-hides)
                let successModal = document.getElementById(
                  "paymentSuccessModal"
                );
                if (!successModal) {
                  successModal = document.createElement("div");
                  successModal.id = "paymentSuccessModal";
                  successModal.className = "modal fade";
                  successModal.innerHTML = `
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-center p-4" style="background: #ffffff; border: 1px solid rgba(0,0,0,0.08); border-radius: 0.5rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.12);">
                <div class="modal-body">
                  <div style="font-size: 4rem; color: #28a745;">
                  <i class="bi bi-check-circle-fill"></i>
                  </div>
                  <h5 class="mt-3 mb-1">Payment recorded</h5>
                  <p class="text-muted small mb-0">The customer will receive an email confirmation shortly.</p>
                </div>
                </div>
              </div>`;
                  document.body.appendChild(successModal);
                }

                const bm = new bootstrap.Modal(successModal, {
                  backdrop: true,
                  keyboard: true,
                });
                bm.show();

                // Auto-hide after 2.2 seconds
                setTimeout(() => {
                  try {
                    bm.hide();
                  } catch (e) {
                    /* ignore */
                  }
                }, 2200);
              })
              .catch((err) => {
                console.error("EmailJS Error:", err);
                showToastWithBlur(
                  "Failed to send payment confirmation email. Please try again.",
                  { type: "error", icon: "fas fa-exclamation-triangle" }
                );
              });
          }

          // Update donation amount_paid and paid status
          if (donationData) {
            const newAmountPaid =
              (donationData.amount_paid || 0) + paymentAmount;
            const isPaid = newAmountPaid >= donationData.pledge_amount;

            const { error: updateError } = await supabaseClient
              .from("donations")
              .update({
                amount_paid: newAmountPaid,
                paid: isPaid,
              })
              .eq("id", donationId);

            if (updateError) {
              showToastWithBlur("Failed to update donation.", {
                type: "error",
                icon: "fas fa-exclamation-triangle",
              });
              console.error(updateError);
              hideLoadingScreen();
              return;
            }
          }

          hideLoadingScreen();
          bootstrap.Modal.getInstance(
            document.getElementById("paymentModal")
          ).hide();
          document.getElementById("paymentForm").reset();
          loadOrders(eventId);
        });

      // Function to resend confirmation email
      window.resendConfirmationEmail = async function(donationId, name, email, pledgeAmount, paymentMethod) {
        // Show confirmation dialog
        // Create and show confirmation modal
        const modalId = 'confirmResendModal';
        let modal = document.getElementById(modalId);
        
        if (!modal) {
          modal = document.createElement('div');
          modal.id = modalId;
          modal.className = 'modal fade';
          modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Resend Confirmation Email</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to resend the confirmation email to:</p>
            <p class="mb-0"><strong>${name}</strong> (${email})</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmResendBtn">Resend Email</button>
          </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        } else {
          // Update modal content with current email details
          modal.querySelector('.modal-body').innerHTML = `
            <p>Are you sure you want to resend the confirmation email to:</p>
            <p class="mb-0"><strong>${name}</strong> (${email})</p>
          `;
        }
        
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        // Wait for user confirmation
        const confirmed = await new Promise((resolve) => {
          const confirmBtn = document.getElementById('confirmResendBtn');
          const cancelHandler = () => {
            resolve(false);
            bootstrapModal.hide();
          };
          const confirmHandler = () => {
            resolve(true);
            bootstrapModal.hide();
          };
          
          confirmBtn.onclick = confirmHandler;
          modal.querySelector('[data-bs-dismiss="modal"]').onclick = cancelHandler;
          modal.addEventListener('hidden.bs.modal', () => {
            confirmBtn.onclick = null;
          }, { once: true });
        });
        
        if (!confirmed) {
          return;
        }
        
        showLoadingScreen();
        
        let emailSent = false;
        try {
          console.log("Attempting to resend email to:", email);
          const emailResponse = await emailjs.send("service_awer6bj", "template_1bl94dp", {
            email: email,
            subject_line: `Donation Pledge: Stella Maris Lights of Hope`,
            name: name,
            email_message: `<p style="font-size: 16px; color: #4b5563; margin-bottom: 20px;">
          Thank you for your generous donation pledge for the <strong>Stella Maris Lights of Hope</strong>.
        </p>

        <p style="font-size: 15px; color: #6b7280; margin-bottom: 10px;">
          Here are the details of your pledge:
        </p>`,
            email_end: `<p style="margin-top: 25px; font-size: 15px; color: #6b7280;">
          If you have any questions, feel free to reply to this email.
        </p>

        <p style="font-size: 15px; color: #6b7280;">
          We look forward to your contribution! Please share this link with your family and friends: <a href="https://stellamarislightsofhope.netlify.app">https://stellamarislightsofhope.netlify.app</a>
        </p>`,
            pledge_amount: formatCurrency(pledgeAmount),
            payment_method: CONFIG.PAYMENT.methods[paymentMethod === "cash" ? "cash" : "bank_transfer"],
            payment_instructions: CONFIG.PAYMENT.instructions[paymentMethod === "cash" ? "cash" : "bank_transfer"],
          });
          console.log("Email resent successfully:", emailResponse);
          emailSent = true;
          
          hideLoadingScreen();
          showToastWithBlur("Confirmation email resent successfully!", {
            type: "success",
            icon: "fas fa-check-circle"
          });
        } catch (emailError) {
          console.error("Failed to resend email. Error details:", emailError);
          console.error("Error message:", emailError.text || emailError.message);
          console.error("Email that failed:", email);
          
          hideLoadingScreen();
          showToastWithBlur("Failed to resend confirmation email. Please try again.", {
            type: "error",
            icon: "fas fa-exclamation-triangle"
          });
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
